<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Apache | hydrocul のメモ</title>
<link rel="stylesheet" href="https://raw.github.com/necolas/normalize.css/master/normalize.css" type="text/css" />
<link rel="stylesheet" href="./common/css/page.css" type="text/css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script src="./common/js/page.js"></script>
</head>
<body>

<div id="breadcrumb">
  <span>Apache</span>
</div>
<div id="side-menu">
  <div id="side-menu-attention">
    このサイトは筆者(hydrocul)の個人メモの集合です。
  </div>
  <div id="side-menu-ls">
    <ul>
  <li><a href="./">Home</a></li>
  <li>&gt; Apache</li>
  <li>&gt; <a href="./commands/">コマンドリファレンス</a></li>
  <li>&gt; <a href="./css.html">CSS</a></li>
  <li>&gt; <a href="./emacs.html">Emacs</a></li>
  <li>&gt; <a href="./google.html">google</a></li>
  <li>&gt; <a href="./google-analytics.html">Google Analytics</a></li>
  <li>&gt; <a href="./ie.html">Internet Explorer</a></li>
  <li>&gt; <a href="./incron.html">incron (inotify cron) (incrontab コマンド)</a></li>
  <li>&gt; <a href="./jquery.html">jQuery</a></li>
  <li>&gt; <a href="./linux.html">Linux</a></li>
  <li>&gt; <a href="./linux-pkg-manager.html">Linuxでのパッケージ管理</a></li>
  <li>&gt; <a href="./mac.html">Mac</a></li>
  <li>&gt; <a href="./mechanize.html">mechanize</a></li>
  <li>&gt; <a href="./memcached.html">memcached</a></li>
  <li>&gt; <a href="./misc.html">misc</a></li>
  <li>&gt; <a href="./mysql.html">MySQL</a></li>
  <li>&gt; <a href="./oneliner.html">ワンライナー</a></li>
  <li>&gt; <a href="./paco.html">Paco (pacKAGE oRGANIZER)</a></li>
  <li>&gt; <a href="./passenger.html">Passenger (Ruby on Rails)</a></li>
  <li>&gt; <a href="./phantomjs.html">phantomjs</a></li>
  <li>&gt; <a href="./php.html">PHP</a></li>
  <li>&gt; <a href="./programming_languages_diff/">プログラミング言語の比較</a></li>
  <li>&gt; <a href="./rails.html">Ruby on Rails</a></li>
  <li>&gt; <a href="./ruby.html">Ruby</a></li>
  <li>&gt; <a href="./sh.html">シェルスクリプト</a></li>
  <li>&gt; <a href="./svn.html">Subversion (svn)</a></li>
  <li>&gt; <a href="./tmux.html">tmux</a></li>
  <li>&gt; <a href="./ubuntu.html">Ubuntu</a></li>
</ul>

  </div>
</div>

<div id="content">
  <h1 id="apache">Apache</h1>

<h2 id="64dc291">OS別のディレクトリ構成</h2>

<h3 id="1516153">Ubuntu
<span class="article-date">2013/09/12</span></h3>

<p>設定ファイルは以下にある。</p>

<pre><code>/etc/apache2/apache2.conf
</code></pre>

<p>以下を <code>Include</code> している。</p>

<pre><code>/etc/apache2/mods-enabled/*.load
/etc/apache2/mods-enabled/*.conf
/etc/apache2/conf.d/*
/etc/apache2/site-enabled/*
</code></pre>

<p>(Ubuntu 12.04 Server, 13.04 Server で確認)</p>

<h3 id="3dfb5b2">Mac OS X
<span class="article-date">2013/04/25</span></h3>

<p>設定ファイルは以下にある。</p>

<pre><code>/etc/apache2/httpd.conf
</code></pre>

<p>※このファイルの実体は以下にある。</p>

<pre><code>/private/etc/apache2/httpd.conf
</code></pre>

<p>以下を <code>Include</code> している。</p>

<pre><code>/etc/apache2/other/*.conf
</code></pre>

<p>(OS X 10.6 で確認)</p>

<h2 id="12fa470">リバースプロキシ
<span class="article-date">2013/04/03</span></h2>

<p>RailsなどWEBrickを動かす場合で、80番ポートでWEBrickにアクセスできるようにするには、Apacheにリバースプロキシを設定すると簡単。passengerを入れるほどでもない場合に。</p>

<p><a href="https://github.com/gitlabhq/gitlab-recipes/blob/master/apache/gitlab" target="_blank">https://github.com/gitlabhq/gitlab-recipes/blob/master/apache/gitlab</a></p>

<p>Apacheの VirtualHost の設定の中に以下のように書く。</p>

<pre><code>ProxyPass / http://127.0.0.1:3000/
ProxyPassReverse / http://127.0.0.1:3000/
ProxyPreserveHost On
</code></pre>

<h2 id="0ce1f7e"><code>.httaccess</code></h2>

<h3 id="9a963f7">ファイルが存在しない場合に限り特定のPHPなどで処理する <code>.htaccess</code>
<span class="article-date">2013/04/24</span></h3>

<pre><code>RewriteEngine on
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule  (.*) index.php/$1 [L]
</code></pre>

<h3 id="8c573d9">特定のURLを除外してBASIC認証をかける <code>.htaccess</code>
<span class="article-date">2013/04/03</span></h3>

<p>例</p>

<pre><code>Satisfy Any

AuthUserFile /var/www/.htpasswd
AuthGroupFile /dev/null
AuthName "secret area"
AuthType Basic
require valid-user

SetEnvIf Request_URI /welcome.html excludeauth
Order deny,allow
Deny from all
Allow from env=excludeauth
</code></pre>

<p>BASIC認証をかけつつ、 <code>SetEnfIf</code> で特定のURLのときに変数を設定して、 <code>Allow</code> でその変数が設定されているときのアクセスを許可する。 <code>Satisfy Any</code> の指定は <code>require</code> と <code>Allow</code> のいずれかが満たされれば、アクセスが許可される、という意味。</p>

<h3 id="87e0974">特定のIPからのアクセスは無条件に許可して、それ以外のアクセスにはBASIC認証をかける <code>.htaccess</code>
<span class="article-date">2013/04/09</span></h3>

<p>例</p>

<pre><code>Satisfy Any

AuthUserFile /path/to/.htpasswd
AuthGroupFile /dev/null
AuthName "hoge"
AuthType Basic
require valid-user

Order deny,allow
Allow from 99.99.99.99
Deny from all
</code></pre>

<h3 id="0355c28">メンテナンス画面に切り替えるための <code>.htaccess</code>
<span class="article-date">2013/04/03</span></h3>

<p>.htaccess の RewriteEngine On の直後に以下を書く</p>

<pre><code>RewriteEngine on
RewriteCond %{REQUEST_URI} !^.*\.(js|css|gif|png|jpg)$
RewriteCond %{REQUEST_URI} !/maintenance\.html$
RewriteRule ^(.*) /maintenance.html [R,L]
</code></pre>

<p>メンテナンスが終わった後は、上記3行を消して、代わりに以下を書く</p>

<pre><code>RewriteRule ^maintenance.html$ / [R,L]
</code></pre>

<h3 id="bb20744">URLの拡張子を .html としたまま、 .php で動かす <code>.htaccess</code>
<span class="article-date">2013/04/23</span></h3>

<pre><code>RewriteEngine on
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)\.html /$1.php
</code></pre>

<h2 id="create-csr">SSLのCSRの作成方法
<span class="article-date">2013/04/03</span></h2>

<pre><code>$ ps aux | openssl md5 &gt; rand.dat
$ openssl genrsa -rand rand.dat -des3 2048 &gt; 2012key.pem
33 semi-random bytes loaded
Generating RSA private key, 1024 bit long modulus
.............................++++++
.......++++++
e is 65537 (0x10001)
Enter pass phrase:
Verifying - Enter pass phrase:
$ openssl req -new -key 2012key.pem -out 2012csr.pem
Enter pass phrase for 2012key.pem:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:JP
State or Province Name (full name) [Some-State]:Tokyo
Locality Name (eg, city) []:Shibuya-ku
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Example Inc.
Organizational Unit Name (eg, section) []:
Common Name (eg, YOUR name) []:www.example.com
Email Address []:←入力しない

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:←入力しない
An optional company name []:←入力しない
$ openssl rsa -in 2012key.pem -out 2012key-nopass.pem
Enter pass phrase for 2012key.pem:
writing RSA key
$ cat 2012key.pem
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: DES-EDE3-CBC,9B527A3154370DC3

MfBHRtPNOcpsvS/v8iROQiKI0OxkG/BDjgms5UcK8lZ0bVbWh+4pPM5k+cIs16b1
...
S3JLM5rJYiDqD68w+v1nr02eQ29eL4o8wosJJvILs5uGfe9/IbGY0g==
-----END RSA PRIVATE KEY-----
$ cat 2012key-nopass.pem
-----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQDHJclRL5NKhmu6A3trgZJY6ZoRQfrjWcnhbxTNDRjS0sQHib/O
...
WxeCZcn78PNkRhnzV18rmniW7ey3GZt3NfDoGSP+4Gml
-----END RSA PRIVATE KEY-----
$ cat 2012csr.pem
-----BEGIN CERTIFICATE REQUEST-----
MIIBpzCCARACAQAwZzELMAkGA1UEBhMCSlAxDjAMBgNVBAgTBVRva3lvMRMwEQYD
...
EAUvkvx4rxqGKbYSr1fyPGWrTU+JSjEAlqz1QU4HPgrL1639qMroMggf8A==
-----END CERTIFICATE REQUEST-----
</code></pre>

<h2 id="openssl">openssl</h2>

<h3 id="80a3081">SSLサーバ証明書ファイルと秘密鍵の組み合わせが正しいことを確認するには
<span class="article-date">2013/05/11</span></h3>

<p><a href="http://www.webimpact.co.jp/banchoblog/?p=624" target="_blank">http://www.webimpact.co.jp/banchoblog/?p=624</a></p>

<p>SSLサーバ証明書ファイルと秘密鍵の組み合わせが正しい場合は、以下のコマンドの出力が全部同じになるはず。</p>

<pre><code>openssl rsa -noout -modulus -in 秘密鍵ファイル | openssl md5
openssl req -noout -modulus -in CSRファイル | openssl md5
openssl x509 -noout -modulus -in サーバ証明書ファイル(CRT) | openssl md5
</code></pre>

<p>もし違う場合は、Apacheが起動しない。</p>

<h3 id="d145129">SSLサーバ証明書の期限を確認するには
<span class="article-date">2013/05/11</span></h3>

<pre><code>openssl x509 -in サーバ証明書ファイル(CRT) -noout -dates
</code></pre>

<h3 id="25f2e41">SSLサーバ証明書の内容を確認するには
<span class="article-date">2013/05/11</span></h3>

<pre><code>openssl x509 -in サーバ証明書ファイル(CRT) -noout -text
</code></pre>

<h3 id="25ec030">SSLサーバ証明書と中間証明書の組み合わせが正しいことを確認するには
<span class="article-date">2013/05/11</span></h3>

<pre><code>openssl verify -CAfile 中間証明書ファイル サーバ証明書ファイル
</code></pre>


</div>

<footer>
  <a href="./">目次</a>
  <!-- Copyright &copy; 2012- @hydrocul All Rights Reserved. -->
</footer>

</body>
</html>
